#!/bin/bash

#    ./lrl <sorted.bam> <targets.bed> <reference.fasta> <repeats.bed> <annotation.gff> <output_prefix>

if [[ $# -ne 6 ]]; then
  echo "usage: ./lrl <sorted.bam> <targets.bed> <reference.fasta> <repeats.bed> <annotation.gff> <output_prefix>"
  exit
fi

bam=$1
bed=$2
ref=$3
repeats=$4
gff=$5
out_prefix=$6

if [ ! -s $bam ]; then
  echo "ERROR: BAM file '$bam' does not exist or is empty"
  exit
fi

if [ ! -s $ref ]; then
  echo "ERROR: Reference FASTA file '$ref' does not exist or is empty"
  exit
fi

if [ ! -s $bed ]; then
  echo "ERROR: Target BED file '$bed' does not exist or is empty"
  exit
fi

if [ ! -s $repeats ]; then
  echo "ERROR: Repeat BED file '$repeats' does not exist or is empty"
  exit
fi

if [ ! -s $gff ]; then
  echo "ERROR: Annotatin GFF file '$gff' does not exist or is empty"
  exit
fi

mkdir -p ${out_prefix%/*}


# fusions
# usage: Call gene fusions/translocations from whole-genome nanopore seq BAM file [-h] [--outdir OUTDIR] [--full] [--genes GENES [GENES ...]] bed repeats bams [bams ...]
python fusions.py --outdir $out_prefix --full $bed $repeats $bam > $out_prefix/fusions.json

# karyotyping
# usage: Digital karyotyping from BAM or binned depth file [-h] [--repeats REPEATS] [--outdir OUTDIR] [--read_lim READ_LIM] [-v] input [input ...]
python karyotype.py --outdir $out_prefix --repeats $repeats $bam > $out_prefix/digital_karyotype.json

# SNVs
# usage: Identify coding variation in nanopore adaptive sampling BAM file [-h] [--genes GENES [GENES ...]] [--phase] bam ref gff
python adaptive_SNVs.py $bam $ref $gff > $out_prefix/snvs.log

# FLT3
# usage: Predict FLT3-ITD and allelic ratio from targeted nanopore sequencing [-h] bam out
python flt3_insilico_pcr.py $bam $out_prefix/flt3_itd.png > $out_prefix/flt3_itd.json

# UBTF
# usage: Predict UBTF-ITD and allelic ratio from targeted nanopore sequencing [-h] bam out
python flt3_insilico_pcr.py $bam $out_prefix/ubtf_itd.png > $out_prefix/ubtf_itd.json

python make_report.py $out_prefix ${out_prefix}/report.docx
